<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <link type="text/css" rel="stylesheet" href="style.css"/>
    <style type="text/css">

text {
  font-size: 11px;
  pointer-events: none;
}

text.parent {
  fill: #1f77b4;
}

circle {
  fill: #ccc;
  stroke: #999;
  pointer-events: all;
}

circle.parent {
  fill: #1f77b4;
  fill-opacity: .1;
  stroke: steelblue;
}

circle.parent:hover {
  stroke: #ff7f0e;
  stroke-width: .5px;
}

circle.child:hover {
  stroke: #ff7f0e;
  stroke-width: .5px;
}

  </style>
  </head>
  <body>
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="http://mbostock.github.com/d3/d3.layout.js"></script>
<script type="text/javascript">
var w = 1280,
    h = 800,
    r = 720,
    x = d3.scale.linear().range([0, r]),
    y = d3.scale.linear().range([0, r]),
    node,
    root,
    depth = 1;

var pack = d3.layout.pack()
    .size([r, r])
    .padding(10)
    .sort(d3.descending)
    .value(function(d) { return d.node_count; });

var vis = d3.select("body").append("svg")
    .attr("width", w)
    .attr("height", h)
  .append("g")
    .attr("transform", "translate(" + (w - r) / 2 + "," + (h - r) / 2 + ")");

d3.json("http://{{ domain }}/graph/bubble", function(data) {
  /*var data = {"node_count": 16, "name": "top_level", "children": [{"node_count": 2, "name": "google.com", "full_url": "google.com"}, {"node_count": 8, "children": [{"node_count": 8, "children": [{"node_count": 1, "name": "sports", "full_url": "reddit.com/r/sports"}, {"node_count": 7, "name": "tech", "full_url": "reddit.com/r/tech"}], "name": "r", "full_url": "reddit.com/r"}], "name": "reddit.com", "full_url": "reddit.com"}, {"node_count": 6, "name": "www.google.com", "full_url": "www.google.com"}]};*/

  /*var data = {"node_count": 5, "name": "top_level", "children": [{"node_count": 2, "name": "www.reddit.com", "children": [{"node_count": 2, "name": "r", "children": [{"node_count": 1, "name": "sports"}, {"node_count": 1, "name": "funny"}]}]}, {"node_count": 2, "name": "stackoverflow.com", "children": [{"node_count": 2, "name": "questions"}, {"node_count": 1, "name": "tags"}]}]};*/

  node = root = data;

  addPlaceholders(root);

  var nodes = pack.nodes(root);

  removePlaceholders(nodes);

  centerNodes(nodes);

  makePositionsRelativeToZero(nodes);

  var node = vis.selectAll(".node")
    .data(nodes)
    .enter()
    .append("g");

  node.append("circle")
    .attr("cx", function(d) { return d.x; })
    .attr("cy", function(d) { return d.y; })
    .attr("r", function(d) {return d.r; })
    .attr("class", function(d) { return d.depth <= depth ? "parent" : "child"; });

  node.append("text")
    .attr("x", function(d) { return d.x; })
    .attr("y", function(d) { return d.y; })
    .attr("dy", ".35em")
    .attr("text-anchor", "middle")
    .style("opacity", function(d) { return d.r > 20 ? 1 : 0; })
    .text(function(d) { return d.depth != depth ? "" : d.name; });
    
  node.attr("visibility", function(d) {return d.depth > depth ? "hidden" : "visible"; });

  var fil = node.filter(function (d) {return d.depth <= depth; }).on("click", click);

  //d3.select(window).on("click", function() { zoom(root); });
});

function click(d) {
  if (d3.event.ctrlKey) {  	
    d3.select(this).remove();
    var linked = true;
    var json = {
    	"url": d.full_url,
    	"linked": linked
    }
    console.log(JSON.stringify(json));
    d3.xhr("http://{{ domain }}/graph/bubble").post(JSON.stringify(json)); 
  }
  else {
    zoom(d);
  }
};

function zoom(d, i) {
  var k = r / d.r / 2;
  x.domain([d.x - d.r, d.x + d.r]);
  y.domain([d.y - d.r, d.y + d.r]);

  console.log("clicked on: "+d.depth);
  
  if (d.children)
    depth = d.depth + 1;
  else
    depth = d.depth;

  console.log(depth);
  
  var t = vis.transition()
      .duration(d3.event.altKey ? 7500 : 750);

  t.selectAll("circle")
      .attr("class", function(d) { return d.depth < depth ? "parent" : "child"; })
      .attr("visibility", function(d) {return d.depth > depth ? "hidden" : "visible"; })
      .attr("cx", function(d) { return x(d.x); })
      .attr("cy", function(d) { return y(d.y); })
      .attr("r", function(d) { return k * d.r; });

  t.selectAll("text")
      .text(function(d) { return d.depth != depth ? "" : d.name; })
      .attr("visibility", function(d) {return d.depth > depth ? "hidden" : "visible"; })
      .attr("x", function(d) { return x(d.x); })
      .attr("y", function(d) { return y(d.y); })
      .style("opacity", function(d) { return k * d.r > 20 ? 1 : 0; });

  node.filter(function (d) {return d.depth <= depth; }).on("click", click);
  node.filter(function (d) {return d.depth > depth; }).on("click", doNothing);
  //node = d;
  d3.event.stopPropagation();
};

function doNothing(d) {

};

function addPlaceholders(node) {
  if(node.children) {
    for( var i = 0; i < node.children.length; i++ ){
          var child = node.children[i];
          addPlaceholders( child );
      }
      if(node.children.length === 1) {
        node.children.push({ name:'placeholder', children: [ { name:'placeholder', children:[] }] });
      }
  }
};

function removePlaceholders( nodes ) {
    for( var i = nodes.length - 1; i >= 0; i-- ) {
        var node = nodes[i];
        if( node.name === 'placeholder' ) {
            nodes.splice(i,1);
        } else {
            if( node.children ) {
                removePlaceholders( node.children );
            }
        }
    }
};

function centerNodes( nodes ) {
    for( var i = 0; i < nodes.length; i ++ ) {
        var node = nodes[i];
        if( node.children ) {
            if( node.children.length === 1) {
                var offset = node.x - node.children[0].x;
                node.children[0].x += offset;
                reposition(node.children[0],offset);
            }
        }
    }

    function reposition( node, offset ) {
        if(node.children) {
            for( var i = 0; i < node.children.length; i++ ) {
                node.children[i].x += offset;
                reposition( node.children[i], offset );
            }
        }
    };
};

function makePositionsRelativeToZero( nodes ) {
    //use this to have vis centered at 0,0,0 (easier for positioning)
    var offsetX = nodes[0].x;
    var offsetY = nodes[0].y;
    for( var i = 0; i < nodes.length; i ++ ) {
        var node = nodes[i];
        node.x -= offsetX;
        node.y -= offsetY;
    }
};
  </script>
  </body>
</html>
