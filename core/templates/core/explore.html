{% extends "core/base.html" %}

{% block explore-nav %}class="active"{% endblock %}

{% block content %}
<body>
	<div align="center" class="col-sm-8 col-sm-offset-2" id="all">
	</div>

<script type="text/javascript">

// dynamically load paginated results when scroll to end of page
$(window).scroll(function() {
	if($(window).scrollTop() + $(window).height() == $(document).height()) {
		console.log("reached bottom");
		$.getJSON( "rank/" + page_num, function( data ) {
			for (var i in data) {
				jsonResp.push(data[i]);
			}
			updateJSON();
			page_num += 1;
			offset += 50;
		});

	}
});
</script>

<script type="text/javascript">
// truncate url titles to 50 chars
function truncate(string){
	if (string.length > 50)
		return string.substring(0,50)+'...';
	else
		return string;
};

function updateJSON() {
	// update results when new data is received

	var items = [];
	for (i = 0 + offset; i < 50 + offset; i++) {
		var title;
		var color;
		var url;
		if (jsonResp[i][1]['last_title']) {
			title = jsonResp[i][1]['last_title'];
		}
		else title = jsonResp[i][0];
		if (jsonResp[i][0].indexOf("&") > -1) {
			url = 'broken_link'
		}
		else {
			url = "http://" + jsonResp[i][0]
		}

		// dynamcially change color based on how good result is
		color = "rgb(" + (241 - (i)) + "," + (27 + i) + "," + (56 + i) + ")";

		var new_div = $("<div>")
		.addClass("explore_div")
		.addClass("row")
		.append($("<div>")
			.addClass("circle")
			.css("float", "left")
			.css("margin", "20px 0px")
			.text(i + 1)
			)
		.append($("<a>")
			.attr("href", url)
			.attr("target", "_blank")
			.append($("<h4>")
				.css("float", "left")
				.css("margin", "30px 0px 0px 20px")
				.text(truncate(title))
				)
			)

		.append($("<div>")
			.addClass("score_circle")
			.css("float", "right")
			.css("margin", "10px 0px")
			.css("background", color)
			.text(parseFloat(jsonResp[i][1]['score']).toFixed(1))
			);

		$("#all").append(new_div);

		var url_div = $("<div>")
		.addClass("row")
			.css("width", "80%")
		.append($("<span>")
			.addClass("glyphicon glyphicon-thumbs-up")
			.attr("onClick", "thumbs_up(" + (i) + ")")
			.attr("id", "up" + (i))
			.css("float", "left")
			.css("margin", "-25px 0px 0px 10px")
			.css("cursor", "pointer")
			)
		.append($("<span>")
			.addClass("glyphicon glyphicon-thumbs-down")
			.css("float", "left")
			.attr("onClick", "thumbs_down(" + (i) + ")")
			.attr("id", "down" + (i))
			.css("margin", "5px 0px 0px 10px")
			.css("cursor", "pointer")
			)
		.append($("<h6>")
			.css("float", "left")
			.css("margin", "0px 0px 0px 36px")
			.text(truncate(jsonResp[i][0].split("/")[0]))
			)
		.append($("<br>")
			);
		$("#all").append(url_div);
		$("#all").append("<hr>");
	}

base = base+50;

$("#all").html($("#all").html());
}
</script>

<script type="text/javascript">
var jsonResp = null;
var base = 0;
var page_num = 1;
var offset = 0;
$(document).ready(function(){
	$.getJSON( "rank/" + page_num, function( data ) {
		jsonResp = data;
		updateJSON();
		page_num += 1;
		offset += 50;
	});
});
</script>

<script type="text/javascript">
// get csrf cookie
var csrftoken = getCookie('csrftoken');
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
};

function thumbs_up(i) {
	// process thumbs up feedback
	if ( ($("#down" + i).css('color')) == 'rgb(255, 0, 0)') {
		$("#down" + i).css( "color", "#6d1daa" );
		$("#up" + i).css( "color", "green" );
		$.ajax({
		 type: 'POST',
		 url: '/up_vote',
		 headers:{"X-CSRFToken":csrftoken},
		 data: {'users': JSON.stringify(jsonResp[i][1]['users'])}
		});
	}
	else if( $("#up" + i).css('color') == 'rgb(0, 128, 0)') {
		$("#up" + i).css( "color", "#6d1daa" );
		$.ajax({
		 type: 'POST',
		 url: '/down_vote',
		 dataType: 'json',
		 headers:{"X-CSRFToken":csrftoken},
		 data: {'users': JSON.stringify(jsonResp[i][1]['users'])}
		});
	}
	else {
		$.ajax({
		 type: 'POST',
		 url: '/up_vote',
		 headers:{"X-CSRFToken":csrftoken},
		 data: {'users': JSON.stringify(jsonResp[i][1]['users'])}
		});
		$("#up" + i).css( "color", "green" );
	}

}
function thumbs_down(i) {
	// process thumbs down feedback
	if ( ($("#up" + i).css('color')) == 'rgb(0, 128, 0)') {
		$("#up" + i).css( "color", "#6d1daa" );
		$.ajax({
		 type: 'POST',
		 url: '/down_vote',
		 headers:{"X-CSRFToken":csrftoken},
		 data: {'users': JSON.stringify(jsonResp[i][1]['users'])}
		});
		$("#down" + i).css( "color", "red" );
	}
	else if ( ($("#down" + i).css('color')) == 'rgb(255, 0, 0)') {
		$("#down" + i).css( "color", "#6d1daa" );
		$.ajax({
		 type: 'POST',
		 url: '/up_vote',
		 headers:{"X-CSRFToken":csrftoken},
		 data: {'users': JSON.stringify(jsonResp[i][1]['users'])}
		});
	}
	else {
		$.ajax({
		 type: 'POST',
		 url: '/down_vote',
		 dataType: 'json',
		 headers:{"X-CSRFToken":csrftoken},
		 data: {'users': JSON.stringify(jsonResp[i][1]['users'])},
		});
		$("#down" + i).css( "color", "red" );
	}
}
</script>
{% endblock %}

